# AirHome 智能控制系统通信协议的实现 #

## 项目概述 ##

&emsp;&emsp;本项目是一个采用C#语言实现的智能家居控制系统通信协议。其适用于智能控制系统中智能设备模块（如WIFI、ZigBee、蓝牙和红外等）与远程服务器或本地智能设备（如手机、平板电脑、PC等）之间进行数据透明传输，协议定义了消息的功能和通信报文格式。

### 建议 ###

1. 为了数据的一致性，每条消息都需要进行回复，即有控制就有反馈、有请求就有响应。
2. 在通信方式上终端模块与服务器采用TCP连接，而本地APP或PC端软件控制采用UDP通信。

### 约定 ###

1. 协议中所有编码方式采用[UTF-8](http://zh.wikipedia.org/zh/UTF-8)（8-bit Unicode Transformation Format）可变长度字符编码。
2. 所有报文数据中的十六进制字符串均使用**大写**形式，即除0~9外，其他字母使用A~F的大写形式。
3. 消息头定义中的“消息体长度”**不包括**自定义转义字符ESC的长度，同时[CRC](http://en.wikipedia.org/wiki/Cyclic_redundancy_check)也**不会对**自定义转义字符ESC进行校验，而是对原字符进行校验，这与消息生成和解析的步骤有关。
4. 由于存在转义字符的原因，相关字节长度会有相应的增加。如灯具色温调节代码0X1002由原来的2个字节变3个字节的0X101BE7，解析时请先替换回原字符。
5. 对于灯具设备，如果有亮度调节、色温调节或[RGB](http://en.wikipedia.org/wiki/RGB_color_model)调节等功能，执行这些功能时将会使用继电器（如果有的话）自动打开。
6. 为了实现灯具设备状态的记忆功能，同时区别**最小亮度调节**与**关闭灯具设备**功能，约定1%为最小的调光等级，具体实现效果由灯具设备决定。

### 定义 ###

1. **设备ID**：设备ID有时也称为UID，每个通信模块出厂时可以人为给定一个编号并烧录到模块中，作为通信模块的唯一标识符。
2. **通道编号**：如果一个设备ID所对应的模块可以控制多个子设备，那么每个子设备通过一个通道编号来标识。需要注意的时，每个子设备可能拥有不同的功能，具体的功能将会在搜索设备时由底层（终端执行控制设备）反馈给上层（服务器或APP等）。
3. **消息类型**：用于表示报文传输的方向和类型，目前支持以下四种，即服务器或APP客户端到终端设备、终端设备到服务器或APP客户端、终端设备主动上报到服务器或APP客户端，以及服务器或APP客户端响应终端设备的上报中告警。
4. **消息ID**：它是一个功能消息的唯一标识。如果一个消息ID为0X0000，那么该消息可能具有多个功能。
5. **消息参数**：由参数类型、参数值长度和参数值组成。此参数可以根据所需功能无限扩展。
6. **设备功能**：即是每个设备（或子设备）所具有的功能，将来可以通过功能代码继续扩展。

### 缩写 ###

1. **STX**：通讯专用字符即文始字符，其全称为Start Of Text，ASCII码值为0X02，它标志着传送正文（数据块）的开始。
2. **ETX**：通讯专用字符即文终字符，其全称为End Of Text，ASCII码值为0X03，它标志着一个数据块的结束。
3. **ESC**：Escape的简写，也称转码字符，ASCII码值为0X1B，本文用于对数据帧起始符和结束符之间出现的STX、ETX以及自身ESC的转义。
4. **CRC**：循环冗余校验（Cyclic Redundancy Check），它是一种常用的差错校验码，用于确保数据传输的正确性和完整性。本文使用的是CRC16查表算法。

## 分区及功能 ##

&emsp;&emsp;每个家庭单元可能拥有一个住所，也有可以拥有多个不同的住所，如一个常住的住所和一个用于度假的别墅。这些依据住所之间可能相距很远，但他们都属于同一个家庭。每个住所由多个房间组成，这些房间可能还会分上下楼，具体的分区由用户自己决定，每个家庭的房间也有所不同。

### 分区层级 ###

1. **家庭**作为整个分组的根， 其包含一个或多个住所。
2. **住宅**是包含一个或多个区域的住所，一个家庭可能拥有多个住所，例如一个主要的住宅和一个度假的别墅。一般而言，一个家庭至少包含一个住所，这个住所也可以不在同一个地方，但在逻辑上它是一体的。
3. **区域**是房间和场所的集合，比如“楼上”、“楼下”和“车库”等。每个住所包含一个或多个区域、每个区域由一个或多个房间或场所组成。
4. **房间**是分区的最小单位，每个住所包含一个或多个房间。

### 功能结构 ###

1. **设备**：此处的设备即为智能产品，其拥有一个或多个通道，具有一个或多个功能，支持WiFi或蓝牙等通信方式进行连接。
2. **通道**：通道也称为回路，每个通道对应一个“子设备”，并可能拥有不同的功能。例如一个智能设备中可能由灯具、摄像头、电机和各种传感器等组成，要想只通过一个WIFI模块控制这些“子设备”，就必须分多路进行操作，而且每一路均有自己的功能特点和控制方式。回路也称为通道，一个回路对应一个“子设备”，如果回路编号为0X00，表示所有回路。
3. **功能**：设备拥有的功能是由设备特性所决定的，例如灯具产品可能拥有开关、亮度调节、色温调节、色彩调节和模式切换等功能，而空调可以进行开关、温度调节以及各种模式切换等。
4. **数据点**：数据点是对功能的细化，每个功能对应一个或多个数据点。例如开关功能对应一个开或关状态的数据点，亮度调节功能对应该一个亮度值数据点；而色温调节功能需要冷色温值和暖色温值两个数据点来实现；色彩调节功能需要红光、绿色和蓝光三个数据点才能实现。

### 设备功能 ###

1. **配置功能**：配置功能用于对设备的信息进行设置操作，如搜索设备、定位设备、设备分组、设置设备名称、设置备注信息、设置定时任务时间、同步时间和恢复出厂设置等。
2. **控制功能**：控制操作会改变设备的工作状态，如电气参数、物理状态等，灯具常用的控制操作如打开或关闭、调节灯具亮度、调节灯具色温、调节灯具RGB等。
3. **数据采集**：为了查看设备当前的运行状态，可以使用数据采集命令到获取，灯具常用的状态包括开关、亮度、色温和RGB等；同时也可以使用该命令来获取设备分组、名称以及备注等信息。
4. **主动请求**：设备根据预先设置的地址主动进行请求，如上电后自动登录到服务器以及定时向服务器发送心跳包等。
5. **事件上报**：当设备检测到事件报警或设备的某此参数超过设定的阈值时，就会触发事件上报。该功能可能需要相关传感器的支持。
6. **数据点功能**：数据点功能是相关功能的细化，它可以用于扩展新功能。

## 通信流程 ##

### 消息下发与回复流程 ###

&emsp;&emsp;服务器或APP客户端向终端设备发送报文消息，终端设备在一定时间内收到该消息后应返回相关的报文消息作为回复。<br/><br/>
&emsp;&emsp;若服务器或APP客户端在T1秒时间内收到终端设备回复的报文消息，那么说明消息发送成功；但如果服务器或APP客户端在该时间内未收到终端设备的回复消息，将重新发送该报文消息。<br/><br/>
&emsp;&emsp;若重发N1次后服务器或APP客户端仍然没有收到终端设备的回复消息，那么将认为报文消息发送失败。其中时间间隔T1和重发次数N1都是可配置的参数，该参数由服务器或APP客户端配置到终端设备进行保存；T1推荐值为5秒，N1推荐值为2次。

### 事件上报与响应流程 ###

&emsp;&emsp;当终端设备某一参数达到阈值或传感器触发报警，就是主动上报事件告警，服务器或APP客户端收到事件消息后，会在一定时间内做出响应。<br/><br/>
&emsp;&emsp;如果终端设备在T2秒内收到了来自服务器或APP客户端的响应消息，则认为事件告警上报成功；与消息下发流程类似，如果终端设备在该时间内没有收到来自上层的响应消息，那么终端设备应该重新发送事件上报消息。<br/><br/>
&emsp;&emsp;在重新发送事件上报消息之前，应该判断消息重发次数是否大于N2次。若重发次数已经大于该次数，则认为事件上报消息发送失败。其中时间间隔T2和重发次数N2都是可配置的参数，该参数由服务器或APP客户端自动保存；T2推荐值为5秒，N2推荐值为2次。

### 心跳包处理流程 ###
&emsp;&emsp;终端设备在与远程服务器通信时，为了确保双方相互知道对方的在线状态，采用相互发送心跳包的方式来解决。例如在服务器端，可能需要开启一个线程来检测是否有新的数据发送过来，如果检测到通信链路收到数据，那么在待T3秒后会再次检测是否收到数据；如果没有检测到通信链路收到数据，服务器就会向终端设备发送一个心跳数据。<br/><br/>
&emsp;&emsp;心跳数据发出之后，服务器会等待T4秒钟，看是否收到终端设备的响应。如果此间服务器收到了终端设备的响应，则继续等待T3秒，然后再次检测是否收到新数据。当然，如果T4秒之后仍然没有收到终端设备的响应，那么服务器将重新发送心跳数据。<br/><br/>
&emsp;&emsp;若重发心跳数据重发N3次后还是未收到终端设备的响应，则应该认为终端设备已经离线，此时应释放与此终端设备的通信连接。上述提到的等待时间T3、时间间隔T4和重发次数N3都应该是可配置的参数，该参数在服务器、APP客户端和终端设备都需要保存；T3推荐值为100秒，T4推荐值为5秒，N3推荐值为3次。

## 报文格式 ##

&emsp;&emsp;为了生成和解析消息具有一致性，并且方便后续扩展新的功能，所有消息数据均采用十六进制形式表示，所有功能指令均进行参数化处理。

### 消息格式定义 ###

&emsp;&emsp;消息报文格式的定义由起始符、消息头、消息体和结束符组成，其具体长度随消息体长度的改变而变化。

<table style="border-collapse: collapse; text-align: center; width: 700px;">
<tr><th></th><th>起始符</th><th>消息头</th><th>消息体</th><th>结束符</th></tr>
<tr><th>表示</th><td>STX</td><td>HEAD</td><td>BODY</td><td>ETX</td></tr>
<tr><th>长度</th><td>1Byte</td><td>12Byte</td><td>可变</td><td>1Byte</td></tr>
<tr><th>取值</th><td>0X02</td><td></td><td></td><td>0X03</td></tr>
</table>

### 转义字符定义 ###

&emsp;&emsp;当数据帧起始符和结束符之间（即消息头和消息体中）出现STX，ETX或ESC时，需要进行转义。

* STX转义为ESC和0XE7，即02->1BE7<br/>
* ETX转义为ESC和0XE8，即03->1BE8<br/>
* ESC转义为ESC和0X00，即1B->1B00

### 消息头定义 ###

&emsp;&emsp;消息头的长度总共有12个字节，依次定义了1个字节的消息类型、2个字节的消息体长度、4个字节的消息序号、3个字节的预留字段和2个字节的消息体CRC校验。

<table style="border-collapse: collapse; text-align: center; width: 700px;">
<tr><th></th><th>消息类型</th><th>消息体长度</th><th>消息序号</th><th>预留</th><th>CRC校验</th></tr>
<tr><th>长度</th><td>1Byte</td><td>2Byte</td><td>4Byte</td><td>3Byte</td><td>2Byte</td></tr>
<tr><th>取值</th><td>00~FF</td><td>0000~FFFF</td><td>00000000~FFFFFFFF</td><td>000000</td><td>0000~FFFF</td></tr>
</table>

**消息类型**：表示消息在设备与服务器或APP之间关系。<br/>
**消息体长度**：可变消息体所占的字节数。<br/>
**消息序号**：取值范围为0~232-1，达到最大值后自动返回从0开始。<br/>
**CRC校验**：对消息体的CRC校验，采用CRC16算法。

### 消息体定义 ###

&emsp;&emsp;消息体定义了消息ID、设备ID和参数列表，其中参数列表由多个参数依次排列，每个参数由参数类型、参数值长度和参数值组成。消息体的长度由参数值长度及参数个数不同而不固定。

<table style="border-collapse: collapse; text-align: center; width: 700px;">
<tr><th rowspan="2"></th><th rowspan="2">消息ID</th><th rowspan="2">设备ID</th><th colspan="4">参数列表</th></tr>
<tr><th>参数1类型</th><th>参数1值长度</th><th>参数1值</th><th>参数2...</th></tr>
<tr><th>长度</th><td>2Byte</td><td>8Byte</td><td>2Byte</td><td>1Byte</td><td>可变</td><td></td></tr>
<tr><th>取值</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
</table>

**消息ID**：报文消息的代码。<br/>
**设备ID**：用于标识设备唯一性的UID，分配方式待定，如果全为0表示广播。兼容其他厂商时，若超过8个字节，取其低（右边）8个字节；若小于8个字节，左边使用0填充。<br/>
**参数类型**：参数的类型代码。<br/>
**参数值长度**：表示某个参数值的字节数，该值不应超过它的类型规定的最大取值。<br/>
**参数值**：长度可变的字符串十六进制表示。

### 消息类型 ###

<table style="border-collapse: collapse; width: 700px;">
<tr><th>代码</th><th>含义</th><th>备注</th></tr>
<tr><th>0X00</th><td>表示服务器或APP客户端到终端设备的配置、控制和获取状态操作。</td><td></td></tr>
<tr><th>0X01</th><td>表示终端设备反馈相关信息到服务器或APP客户端。</td><td>即反馈0X00操作执行的结果。</td></tr>
<tr><th>0X02</th><td>表示终端设备主动请求或上报自己的状态或告警到服务器或APP客户端。</td><td></td></tr>
<tr><th>0X03</th><td>表示服务器或APP客户端响应终端设备的状态上报或告警。</td><td>即响应0X1BE7请求或上报操作执行的结果。</td></tr>
<tr><th>0X04</th><td>预留</td><td></td></tr>
</table>